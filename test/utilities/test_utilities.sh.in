#! /usr/bin/env bash

##############################################################################
# @file  test_utilities.sh
# @brief Test BASIS utilities.
#
# This test first builds the test project which is based on BASIS and then
# triggers the execution of the separate test cases which are built as part
# of this test project.
#
# Copyright (c) 2011 University of Pennsylvania. All rights reserved.
# See https://www.rad.upenn.edu/sbia/software/license.html or COPYING file.
#
# Contact: SBIA Group <sbia-software at uphs.upenn.edu>
##############################################################################

@BASIS_BASH_UTILITIES@

# ============================================================================
# constants
# ============================================================================

basis_dir='@TESTING_BASIS_DIR@'
ressources_dir='@TESTING_DIR@/ressources/test_utilities'
source_dir='@TESTING_OUTPUT_DIR@/test_utilities-source'
binary_dir='@TESTING_OUTPUT_DIR@/test_utilities-build'

get_executable_path basisproject_path 'basis::basisproject.sh'
[ -z "${basisproject_path}" ] && { echo "FAILED to get path of basisproject command!"; exit 1; }

readonly cwd="$(pwd)"

# ============================================================================
# options
# ============================================================================

FLAGS "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

# ============================================================================
# helpers
# ============================================================================

##############################################################################
# @brief Run command with arguments and exit on failure.
run ()
{
    if [ ${FLAGS_verbose} -gt 0 ]; then
        echo "\$> $@"
    fi
    "$@"
    local errcode=$?
    if [ ${errcode} -ne 0 ] ; then
        echo
        echo "Failed to run command $@" 1>&2
        echo
        echo "FAILED"
        exit ${errcode}
    fi
    return 0
}

##############################################################################
# @brief Run command with arguments where error is expected.
runerr ()
{
    if [ ${FLAGS_verbose} -gt 0 ]; then
        echo "\$> $@"
    fi
    "$@"
    local errcode=$?
    if [ ${errcode} -eq 0 ] ; then
        echo
        echo "Command $@ was unexpectedly successful" 1>&2
        echo
        echo "FAILED"
        exit 1
    fi
    return 0
}

##############################################################################
# @brief Creates a project using the basisproject command-line tool.
create ()
{
    echo "Creating test project..."
    [ -d "${source_dir}" ] && run rm -rf "${source_dir}"
    run "${basisproject_path}" --name 'TestUtilities' \
        --description "A project used to test the BASIS utilities." \
        --root "${source_dir}" \
        --language CXX \
        --language Java \
        --language Python \
        --language Perl \
        --language BASH \
        --language MATLAB
    echo "Creating test project... - done"
}

##############################################################################
# @brief Tries to build a project created by basisproject.
build ()
{
    echo "Configuring test project..."
    [ -d "${binary_dir}" ] && run rm -rf "${binary_dir}"
    run mkdir -p "${binary_dir}"
    run cd "${binary_dir}"
    run cmake "-DBASIS_DIR=${basis_dir}" "${source_dir}"
    echo "Configuring test project... - done"
    echo "Building test project..."
    run make
    echo "Building test project... - done"

    run cd "${cwd}"
}

##############################################################################
# @brief Copy file from ressources directory to project source tree.
#
# @param [in] file   File path relative to top directory of ressources tree.
# @param [in] prefix Path prefix relative to project source tree. Defaults
#                    to the root of the project source tree itself.
# @param [in] name   Name of file in project source tree. Defaults to the
#                    name of the file given by @p file.
#
# @returns Nothing.
copy ()
{
    local file=$1
    local prefix=${2:-'.'}
    local name=${3:-"$(basename "$file")"}
    run cp "${ressources_dir}/${file}" "${source_dir}/${prefix}/$(dirname "$file")/${name}"
}

##############################################################################
# @brief Add test to test project.
add_test ()
{
    local impl=$1
    copy ${impl} 'test'
    echo "basis_add_test (\"${impl}\")" >> "${source_dir}/test/CMakeLists.txt"
}

##############################################################################
# @brief Cleanup source and binary tree.
cleanup ()
{
    [ -d "${source_dir}" ] && run rm -rf "${source_dir}"
    [ -d "${binary_dir}" ] && run rm -rf "${binary_dir}"
}

# ============================================================================
# main
# ============================================================================

create
add_test 'test_ExecutableTargetInfo.pl.in'
build
run cd "${binary_dir}"
if [ ${FLAGS_verbose} -gt 1 ]; then
    run ctest -V -V
elif [ ${FLAGS_verbose} -gt 0 ]; then
    run ctest -V
else
    run ctest
fi
cd "${cwd}"
#cleanup
exit 0
