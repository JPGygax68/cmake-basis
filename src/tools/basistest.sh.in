#! /usr/bin/env bash

##
# @file  basistest.sh
# @brief Common wrapper for the basistest subcommands.
#
# Copyright (c) 2011 University of Pennsylvania. All rights reserved.
# See COPYING file or https://www.rad.upenn.edu/sbia/software/license.html.
#
# Contact: SBIA Group <sbia-software at uphs.upenn.edu>

@BASIS_BASH_UTILITIES@

# ============================================================================
# constants
# ============================================================================

get_executable_name      _EXEC_NAME && readonly _EXEC_NAME
get_executable_directory _EXEC_DIR  && readonly _EXEC_DIR

# ============================================================================
# help
# ============================================================================

# ----------------------------------------------------------------------------
## @brief Print help.
function print_help
{
    print_synopsis
    echo
    cat - << EOF-DESCRIPTION
Description:
  This executable is a wrapper for the basistest subcommands. The name of the
  subcommand to execute must be given as first argument.
EOF-DESCRIPTION
    echo
    print_options
    echo
    print_contact
}

# ----------------------------------------------------------------------------
## @brief Print usage information.
function print_helpshort
{
    print_synopsis
    echo
    print_options
    echo
    print_contact
}

# ----------------------------------------------------------------------------
## @brief Print synopsis, i.e., usage section.
function print_synopsis
{
    cat - << EOF-SYNOPSIS
Usage:
  ${_EXEC_NAME} <cmd> [options] [options of subcommand]
  ${_EXEC_NAME} help <cmd>
  ${_EXEC_NAME} [options]
EOF-SYNOPSIS
}

# ----------------------------------------------------------------------------
## @brief Print options.
function print_options
{
    cat - << EOF-OPTIONS
Options:
  <cmd>         Recognized subcommands are cron, master, slave, and svn.
  --help, -h    Print help and exit
  --helpshort   Print short help and exit.
EOF-OPTIONS
}

# ============================================================================
# options
# ============================================================================

if [ $# -eq 0 ]; then
    print_help
    exit 1
fi

cmd=''    # subcommand to run
args=()   # options of subcommand
verbose=0 # verbosity of output messages

if [ -n "$1" ]; then
    if match "$1" '^(cron|master|slave|svn)$'; then
        cmd="$1"
        shift
    elif [ "$1" == "help" ]; then
        if [ -n "$2" ]; then
            if match "$2" '^(cron|master|slave|svn)$'; then
                cmd="$2"
                shift
            else
                echo "Unknown command: $2" 1>&2
                exit 1
            fi
        else
            echo "Missing subcommand! See ${_EXEC_NAME} --help." 1>&2
            exit 1
        fi

        exec "${_EXEC_DIR}/basistest-${cmd}" '--help'
    elif [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        print_help
        exit 0
    elif [ "$1" == "--helpshort" ]; then
        print_helpshort
        exit 0
    elif [ "$1" == "--version" ]; then
        print_version '@NAME@'
        exit 0
    fi
fi

# ============================================================================
# main
# ============================================================================

[ -n "${cmd}" ] || { echo "Missing subcommand! See ${_EXEC_NAME} --help."; exit 1; }
exec "${_EXEC_DIR}/basistest-${cmd}" "$@"
